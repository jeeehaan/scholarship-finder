{% extends 'base.html' %}

{% block content %}
<!-- Navbar -->
<nav class="container flex justify-between mx-auto p-4">
    <div class="text-primary text-xl font-bold">ScholarshipFinder</div>
    <div class="flex gap-12 items-center">
        <form id="search-form" method="get" action="{% url 'search' %}">
            <input name="q" id="search-input" class="input input-primary" placeholder="Search scholarships...">
        </form>
        
        <!-- Chat Toggle Button (visible on mobile) -->
        <button id="chat-toggle" class="btn btn-primary btn-sm lg:hidden">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
            </svg>
            Chat
        </button>
        
        <div x-data="{ open: false }" class="relative">
            <!-- Avatar Button -->
            <button @click="open = !open" class="avatar avatar-placeholder focus:outline-none">
                <div class="bg-neutral text-neutral-content w-10 rounded-full flex items-center justify-center">
                    <span class="text-sm">{{ user.first_name|first|upper}}</span>
                </div>
            </button>
            
            <!-- Dropdown Menu -->
            <div x-show="open" 
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 @click.outside="open = false"
                 class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                <a href="{% url 'logout' %}" 
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150">
                    Logout
                </a>
            </div>
        </div>
    </div>
</nav>
<!--   End Navbar-->

<!-- Main Content with Chat -->
<div class="flex h-screen pt-8"> <!-- pt-20 to account for navbar height -->
    <!-- Dashboard Content (Left Side) -->
    <main class="flex-1 overflow-y-auto bg-base-100">
        <div class="container mx-auto px-8 py-4">
            <section class="pt-4 pb-6">
                <p class="text-3xl font-bold text-gray-800">Welcome back, {{ user.first_name }}!</p>
                <p class="text-gray-600">Here are scholarships that match your preference</p>
            </section>

            <section>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Recommended For You</h2>
                <div class="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-6">
                    {% if scholarships %}
                        {% for scholarship in scholarships %}    
                        {% include 'components/scholarship-card.html' with scholarship=scholarship %} 
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 col-span-full text-center py-8">No scholarships found.</p>
                    {% endif %}
                </div>
            </section>
        </div>
    </main>

    <!-- Chat Panel (Right Side) -->
    <aside id="chat-panel" class="w-96 bg-base-200 border-l border-base-300 flex flex-col lg:flex">
        <!-- Chat Header -->
        <div class="p-4 bg-primary text-primary-content border-b border-base-300">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
                    </svg>
                    Chat Assistant
                </h3>
                <button id="chat-close" class="btn btn-ghost btn-sm btn-circle lg:hidden">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-primary-content/80 mt-1">Ask me about scholarships</p>
        </div>

        <!-- Chat Messages -->
        <div id="chats" class="flex-1 p-4 overflow-y-auto space-y-4 bg-base-100">
            {% for chat in conversation %}
            <div class="chat {% if chat.role == 'user' %}chat-end{% else %}chat-start{% endif %}">
                <div class="chat-image avatar avatar-placeholder">
                    <div class="w-8 text-white rounded-full bg-{% if chat.role == 'user' %}primary{% else %}gray-600{% endif %}">
                        {% if chat.role == 'user' %}
                           <span class="text-xs">{{ user.first_name|first|upper }}</span>
                        {% else %}
                           <span class="text-xs">A</span>
                        {% endif %}
                    </div>
                </div>
                <div class="chat-header text-xs opacity-50 mb-1">
                    {% if chat.role == 'user' %}You{% else %}Assistant{% endif %}
                </div>
                <div class="chat-bubble chat-bubble-{% if chat.role == 'user' %}primary{% else %}secondary{% endif %} text-sm">
                    {{ chat.message }}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="px-4 py-2 hidden">
            <div class="flex items-center gap-2 text-sm text-base-content/60">
                <span class="loading loading-dots loading-sm"></span>
                Assistant is typing...
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 bg-base-200 border-t border-base-300">
            <div class="flex gap-2">
                <input 
                    id="chat-message-input" 
                    type="text" 
                    class="input input-bordered input-sm flex-1 focus:input-primary" 
                    placeholder="Ask about scholarships..." 
                    autofocus 
                    autocomplete="off"
                />
                <button 
                    id="chat-message-submit" 
                    class="btn btn-primary btn-sm"
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </aside>
</div>

<!-- Mobile Chat Overlay -->
<div id="chat-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden">
    <div class="fixed right-0 top-0 h-full w-full max-w-sm bg-base-100 transform transition-transform duration-300 translate-x-full">
        <!-- Same chat content as desktop, but in overlay -->
        <div class="h-full flex flex-col">
            <!-- Chat Header -->
            <div class="p-4 bg-primary text-primary-content border-b border-base-300">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
                        </svg>
                        Chat Assistant
                    </h3>
                    <button id="chat-overlay-close" class="btn btn-ghost btn-sm btn-circle">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-primary-content/80 mt-1">Ask me about scholarships</p>
            </div>

            <!-- Mobile chat messages mirror -->
            <div id="chats-mobile" class="flex-1 p-4 overflow-y-auto space-y-4 bg-base-100">
                <!-- Will be synced with desktop chat -->
            </div>

            <!-- Mobile chat input -->
            <div class="p-4 bg-base-200 border-t border-base-300">
                <div class="flex gap-2">
                    <input 
                        id="chat-message-input-mobile" 
                        type="text" 
                        class="input input-bordered input-sm flex-1 focus:input-primary" 
                        placeholder="Ask about scholarships..." 
                        autocomplete="off"
                    />
                    <button 
                        id="chat-message-submit-mobile" 
                        class="btn btn-primary btn-sm"
                    >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Search functionality
    document.getElementById("search-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            document.getElementById("search-form").submit();
        }
    });

    // Mobile chat toggle
    const chatToggle = document.getElementById('chat-toggle');
    const chatOverlay = document.getElementById('chat-overlay');
    const chatOverlayClose = document.getElementById('chat-overlay-close');
    const chatOverlayPanel = chatOverlay.querySelector('.fixed.right-0');

    chatToggle.addEventListener('click', () => {
        chatOverlay.classList.remove('hidden');
        setTimeout(() => {
            chatOverlayPanel.classList.remove('translate-x-full');
        }, 10);
    });

    function closeMobileChat() {
        chatOverlayPanel.classList.add('translate-x-full');
        setTimeout(() => {
            chatOverlay.classList.add('hidden');
        }, 300);
    }

    chatOverlayClose.addEventListener('click', closeMobileChat);
    chatOverlay.addEventListener('click', (e) => {
        if (e.target === chatOverlay) {
            closeMobileChat();
        }
    });

    // WebSocket Chat Functionality
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${ws_scheme}://${window.location.host}/ws/chat/`);
    
    const chatContainer = document.getElementById('chats');
    const chatContainerMobile = document.getElementById('chats-mobile');
    const loadingIndicator = document.getElementById('loading-indicator');

    // Sync mobile and desktop chat
    function syncChatContainers() {
        chatContainerMobile.innerHTML = chatContainer.innerHTML;
    }

    // Auto scroll to bottom
    function scrollToBottom(container = chatContainer) {
        container.scrollTop = container.scrollHeight;
    }

    // Create chat message
    function createChatMessage(message, isUser = false) {
        const chatDiv = document.createElement('div');
        chatDiv.className = `chat ${isUser ? 'chat-end' : 'chat-start'}`;
        
        // Get user's first initial from the page (from Django template)
        const userInitial = document.querySelector('nav .avatar span')?.textContent || 'U';
        
        chatDiv.innerHTML = `
            <div class="chat-image avatar avatar-placeholder">
                <div class="w-8 text-white rounded-full bg-${isUser ? 'primary' : 'gray-600'} flex items-center justify-center">
                    <span class="text-xs">${isUser ? userInitial : 'A'}</span>
                </div>
            </div>
            <div class="chat-header text-xs opacity-50 mb-1">
                ${isUser ? 'You' : 'Assistant'}
            </div>
            <div class="chat-bubble chat-bubble-${isUser ? 'primary' : 'secondary'} text-sm">
                ${marked.parse(message)}
            </div>
        `;
        
        return chatDiv;
    }

    // Create simple scholarship recommendation
    function createScholarshipRecommendation(scholarship) {
        const recDiv = document.createElement('div');
        recDiv.className = 'bg-base-200 rounded-lg p-3 border-l-4 border-primary mt-2';
        
        recDiv.innerHTML = `
            <h4 class="font-medium text-sm mb-1">
                <a href="/dashboard/${scholarship.id}/" target="_blank" class="text-primary hover:text-primary-focus hover:underline transition-colors">
                    ${scholarship.title}
                </a>
            </h4>
            <p class="text-xs text-base-content/70 line-clamp-2">${scholarship.description}</p>
        `;
        
        return recDiv;
    }

    // Handle chat input
    function handleChatSubmit(inputElement) {
        const message = inputElement.value.trim();
        if (message === '') return;

        // Show user message
        const userMessage = createChatMessage(message, true);
        chatContainer.appendChild(userMessage);
        scrollToBottom();
        syncChatContainers();
        scrollToBottom(chatContainerMobile);

        // Show loading
        loadingIndicator.classList.remove('hidden');

        // Send message
        ws.send(JSON.stringify({
            'message': message
        }));
        
        inputElement.value = '';
    }

    // Desktop chat input events
    const chatInput = document.getElementById('chat-message-input');
    const chatSubmit = document.getElementById('chat-message-submit');

    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleChatSubmit(chatInput);
        }
    });

    chatSubmit.addEventListener('click', () => {
        handleChatSubmit(chatInput);
    });

    // Mobile chat input events
    const chatInputMobile = document.getElementById('chat-message-input-mobile');
    const chatSubmitMobile = document.getElementById('chat-message-submit-mobile');

    chatInputMobile.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleChatSubmit(chatInputMobile);
        }
    });

    chatSubmitMobile.addEventListener('click', () => {
        handleChatSubmit(chatInputMobile);
    });

    // WebSocket event handlers
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        // Hide loading
        loadingIndicator.classList.add('hidden');
        
        // Show assistant message
        if (data.message) {
            const assistantMessage = createChatMessage(data.message, false);
            chatContainer.appendChild(assistantMessage);
            
            // Add scholarships directly under the assistant message if they exist
            if (data.scholarships && data.scholarships.length > 0) {
                const scholarshipsContainer = document.createElement('div');
                scholarshipsContainer.className = 'ml-12 space-y-2 mt-2'; // ml-12 to align with chat bubble
                
                data.scholarships.forEach(scholarship => {
                    const recommendation = createScholarshipRecommendation(scholarship);
                    scholarshipsContainer.appendChild(recommendation);
                });
                
                chatContainer.appendChild(scholarshipsContainer);
            }
            
            scrollToBottom();
            syncChatContainers();
            scrollToBottom(chatContainerMobile);
        }
    };

    ws.onopen = () => {
        console.log("Connected to chat");
    };

    ws.onclose = () => {
        console.log("Disconnected from chat");
    };

    ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        loadingIndicator.classList.add('hidden');
    };
</script>

<style>
    /* Custom styles */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    /* Smooth scrolling */
    #chats, #chats-mobile {
        scroll-behavior: smooth;
    }
    
    /* Custom scrollbar */
    #chats::-webkit-scrollbar, #chats-mobile::-webkit-scrollbar {
        width: 4px;
    }
    
    #chats::-webkit-scrollbar-track, #chats-mobile::-webkit-scrollbar-track {
        background: hsl(var(--b2));
    }
    
    #chats::-webkit-scrollbar-thumb, #chats-mobile::-webkit-scrollbar-thumb {
        background: hsl(var(--bc) / 0.2);
        border-radius: 2px;
    }
    
    /* Responsive grid adjustments */
    @media (max-width: 1280px) {
        .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }
    }
</style>
{% endblock %}